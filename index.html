    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmP8esoCsmHsxAObhzb8eNDQvdtfFJ3gU",
            authDomain: "ingenio-mahuixtlan.firebaseapp.com",
            projectId: "ingenio-mahuixtlan",
            storageBucket: "ingenio-mahuixtlan.firebasestorage.app",
            messagingSenderId: "835526438503",
            appId: "1:835526438503:web:851ffb19a5e966e759eec2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        let userData = [];
        let editingIndex = -1;
        let currentUser = '';
        let editingDocId = null;

        // Hacer funciones disponibles globalmente
        window.handleLogin = handleLogin;
        window.logout = logout;
        window.showSection = showSection;
        window.saveRecord = saveRecord;
        window.clearForm = clearForm;
        window.cancelEdit = cancelEdit;
        window.editRecord = editRecord;
        window.deleteRecord = deleteRecord;
        window.exportToExcel = exportToExcel;

        // Verificar estado de autenticaci√≥n
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user.email;
                document.getElementById('currentUser').textContent = user.email;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadDataFromFirebase();
                showSection('capture');
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // Funci√≥n de login con Firebase
        async function handleLogin() {
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginAlert = document.getElementById('loginAlert');
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                loginAlert.textContent = 'Por favor complete todos los campos';
                loginAlert.classList.remove('hidden');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading-spinner"></span> Entrando...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginAlert.classList.add('hidden');
            } catch (error) {
                console.error('Error de login:', error);
                let errorMessage = 'Error al iniciar sesi√≥n';
                
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Correo electr√≥nico inv√°lido';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contrase√±a incorrecta';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Credenciales inv√°lidas. Verifica tu correo y contrase√±a.';
                }
                
                loginAlert.textContent = errorMessage;
                loginAlert.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar';
            }
        }

        // Funci√≥n de logout
        async function logout() {
            try {
                await signOut(auth);
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                clearForm();
                userData = [];
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
                showAlert('Error al cerrar sesi√≥n', 'error');
            }
        }

        // Cargar datos desde Firebase
        async function loadDataFromFirebase() {
            try {
                const q = query(collection(db, 'labores_agricolas'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                userData = [];
                querySnapshot.forEach((doc) => {
                    userData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`${userData.length} registros cargados desde Firebase`);
            } catch (error) {
                console.error('Error al cargar datos:', error);
                showAlert('Error al cargar datos de la base de datos', 'error');
            }
        }

        // Mostrar secciones
        function showSection(section) {
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.getElementById(section + 'Section').classList.add('active');
            
            if (section === 'reports') {
                updateStats();
            } else if (section === 'data') {
                loadDataTable();
            }
        }

        // Guardar registro en Firebase
        async function saveRecord() {
            const formData = {
                zafra_ciclo: document.getElementById('zafra_ciclo').value,
                zona: document.getElementById('zona').value,
                campo: document.getElementById('campo').value,
                id_prod: document.getElementById('id_prod').value,
                nombre_productor: document.getElementById('nombre_productor').value,
                superficie: document.getElementById('superficie').value,
                ciclo: document.getElementById('ciclo').value,
                regimen: document.getElementById('regimen').value,
                fecha_avance: document.getElementById('fecha_avance').value,
                observaciones: document.getElementById('observaciones').value,
                timestamp: new Date().toISOString(),
                user: currentUser,
                
                labores: {
                    desmonte: document.getElementById('desmonte').checked,
                    primer_barbecho: document.getElementById('primer_barbecho').checked,
                    segundo_barbecho: document.getElementById('segundo_barbecho').checked,
                    ap_encalado: document.getElementById('ap_encalado').checked,
                    primera_rastra: document.getElementById('primera_rastra').checked,
                    surco: document.getElementById('surco').checked,
                    siembra_amp: document.getElementById('siembra_amp').checked,
                    siembra_rep: document.getElementById('siembra_rep').checked,
                    jta_quema: document.getElementById('jta_quema').checked,
                    primer_cultivo: document.getElementById('primer_cultivo').checked,
                    primer_cultivo_yta: document.getElementById('primer_cultivo_yta').checked,
                    primera_ap_fertilizante: document.getElementById('primera_ap_fertilizante').checked,
                    primera_ap_fert_mec: document.getElementById('primera_ap_fert_mec').checked,
                    primer_riego: document.getElementById('primer_riego').checked,
                    subsuelo_ctral: document.getElementById('subsuelo_ctral').checked,
                    primera_limpia: document.getElementById('primera_limpia').checked,
                    primera_ap_herbicida: document.getElementById('primera_ap_herbicida').checked,
                    segunda_ap_ferti: document.getElementById('segunda_ap_ferti').checked,
                    segundo_riego: document.getElementById('segundo_riego').checked,
                    segunda_limpia: document.getElementById('segunda_limpia').checked,
                    segunda_ap_herbicida: document.getElementById('segunda_ap_herbicida').checked,
                    resiembra: document.getElementById('resiembra').checked
                }
            };

            // Validar campos requeridos
            const requiredFields = ['zafra_ciclo', 'zona', 'campo', 'id_prod', 'nombre_productor', 'superficie', 'ciclo', 'regimen', 'fecha_avance'];
            let isValid = true;
            
            for (let field of requiredFields) {
                if (!formData[field]) {
                    isValid = false;
                    document.getElementById(field).style.borderColor = '#dc3545';
                } else {
                    document.getElementById(field).style.borderColor = '#e0e0e0';
                }
            }

            if (!isValid) {
                showAlert('Por favor complete todos los campos requeridos (*)', 'error');
                return;
            }

            try {
                if (editingDocId) {
                    // Actualizar registro existente
                    const docRef = doc(db, 'labores_agricolas', editingDocId);
                    await updateDoc(docRef, formData);
                    showAlert('Registro actualizado exitosamente en Firebase', 'success');
                    editingDocId = null;
                    document.getElementById('cancelEdit').classList.add('hidden');
                } else {
                    // Crear nuevo registro
                    await addDoc(collection(db, 'labores_agricolas'), formData);
                    showAlert('Registro guardado exitosamente en Firebase', 'success');
                }

                await loadDataFromFirebase();
                clearForm();
            } catch (error) {
                console.error('Error al guardar:', error);
                showAlert('Error al guardar en la base de datos', 'error');
            }
        }

        // Limpiar formulario
        function clearForm() {
            const textFields = ['zafra_ciclo', 'zona', 'campo', 'id_prod', 'nombre_productor', 'superficie', 'ciclo', 'regimen', 'fecha_avance', 'observaciones'];
            textFields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = '';
                    element.style.borderColor = '#e0e0e0';
                }
            });

            const checkboxes = ['desmonte', 'primer_barbecho', 'segundo_barbecho', 'ap_encalado', 'primera_rastra', 'surco', 'siembra_amp', 'siembra_rep', 'jta_quema', 'primer_cultivo', 'primer_cultivo_yta', 'primera_ap_fertilizante', 'primera_ap_fert_mec', 'primer_riego', 'subsuelo_ctral', 'primera_limpia', 'primera_ap_herbicida', 'segunda_ap_ferti', 'segundo_riego', 'segunda_limpia', 'segunda_ap_herbicida', 'resiembra'];
            checkboxes.forEach(checkbox => {
                document.getElementById(checkbox).checked = false;
            });

            editingIndex = -1;
            editingDocId = null;
            document.getElementById('cancelEdit').classList.add('hidden');
            
            // Establecer fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha_avance').value = today;
        }

        // Cancelar edici√≥n
        function cancelEdit() {
            clearForm();
            editingIndex = -1;
            editingDocId = null;
            document.getElementById('cancelEdit').classList.add('hidden');
            showAlert('Edici√≥n cancelada', 'success');
        }

        // Mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.getElementById('formAlert');
            alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // Actualizar estad√≠sticas y generar informes
        function updateStats() {
            if (userData.length === 0) {
                document.getElementById('totalSuperficie').textContent = '0';
                document.getElementById('avgLaboresPorProductor').textContent = '0';
                document.getElementById('productoresActivos').textContent = '0';
                document.getElementById('porcentajeAvanceGeneral').textContent = '0%';
                return;
            }

            const totalSuperficie = userData.reduce((sum, record) => sum + parseFloat(record.superficie || 0), 0);
            const productoresActivos = userData.length;
            
            let totalLabores = 0;
            userData.forEach(record => {
                if (record.labores) {
                    totalLabores += Object.values(record.labores).filter(Boolean).length;
                }
            });
            const avgLabores = userData.length > 0 ? (totalLabores / userData.length).toFixed(1) : 0;
            const porcentajeAvance = userData.length > 0 ? ((totalLabores / (userData.length * 22)) * 100).toFixed(1) : 0;
            
            document.getElementById('totalSuperficie').textContent = totalSuperficie.toFixed(1);
            document.getElementById('avgLaboresPorProductor').textContent = avgLabores;
            document.getElementById('productoresActivos').textContent = productoresActivos;
            document.getElementById('porcentajeAvanceGeneral').textContent = porcentajeAvance + '%';
            
            generateLaborSuperficieReport();
            generateZonaAvanceReport();
            generateCicloComparativa();
        }

        // Reporte de superficie por labor
        function generateLaborSuperficieReport() {
            const laborNames = {
                'desmonte': 'Desmonte',
                'primer_barbecho': '1er. Barbecho',
                'segundo_barbecho': '2do. Barbecho',
                'ap_encalado': 'Ap./Encalado',
                'primera_rastra': '1ra. Rastra',
                'surco': 'Surco',
                'siembra_amp': 'Siembra-Amp.',
                'siembra_rep': 'Siembra-Rep.',
                'jta_quema': 'Jta. Quema',
                'primer_cultivo': '1er. Cultivo',
                'primer_cultivo_yta': '1er. Cultivo/Yta.',
                'primera_ap_fertilizante': '1ra. Ap/Fertilizante',
                'primera_ap_fert_mec': '1ra. Ap/Fert.Mec.',
                'primer_riego': '1er. Riego',
                'subsuelo_ctral': 'Subsuelo/Ctral.',
                'primera_limpia': '1ra. Limpia',
                'primera_ap_herbicida': '1ra. Ap/Herbicida',
                'segunda_ap_ferti': '2da. Ap/Ferti.',
                'segundo_riego': '2do. Riego',
                'segunda_limpia': '2da. Limpia',
                'segunda_ap_herbicida': '2da. Ap/Herbicida',
                'resiembra': 'Resiembra'
            };

            const laborStats = {};
            Object.keys(laborNames).forEach(labor => {
                laborStats[labor] = { superficie: 0, productores: 0 };
            });
            
            userData.forEach(record => {
                const superficie = parseFloat(record.superficie || 0);
                if (record.labores) {
                    Object.keys(laborNames).forEach(labor => {
                        if (record.labores[labor]) {
                            laborStats[labor].superficie += superficie;
                            laborStats[labor].productores += 1;
                        }
                    });
                }
            });
            
            let tableHTML = `
                <table class="data-table" style="font-size: 13px;">
                    <thead>
                        <tr>
                            <th>Labor Agr√≠cola</th>
                            <th>Superficie (Ha)</th>
                            <th>Productores</th>
                            <th>% Avance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const totalSuperficie = userData.reduce((sum, record) => sum + parseFloat(record.superficie || 0), 0);
            
            Object.keys(laborNames).forEach(labor => {
                const stats = laborStats[labor];
                const porcentaje = totalSuperficie > 0 ? ((stats.superficie / totalSuperficie) * 100).toFixed(1) : 0;
                
                tableHTML += `
                    <tr>
                        <td><strong>${laborNames[labor]}</strong></td>
                        <td>${stats.superficie.toFixed(1)}</td>
                        <td>${stats.productores}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="background: #e0e0e0; height: 8px; width: 100px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: rgb(34,116,71); height: 100%; width: ${porcentaje}%; transition: width 0.3s;"></div>
                                </div>
                                <span>${porcentaje}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('laborSuperficieTable').innerHTML = tableHTML;
        }

        // Reporte por zona
        function generateZonaAvanceReport() {
            const zonaStats = {};
            
            userData.forEach(record => {
                const zona = record.zona || 'Sin zona';
                const superficie = parseFloat(record.superficie || 0);
                
                if (!zonaStats[zona]) {
                    zonaStats[zona] = { superficie: 0, productores: 0, laboresTotal: 0 };
                }
                
                zonaStats[zona].superficie += superficie;
                zonaStats[zona].productores += 1;
                
                if (record.labores) {
                    zonaStats[zona].laboresTotal += Object.values(record.labores).filter(Boolean).length;
                }
            });
            
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Zona</th>
                            <th>Superficie (Ha)</th>
                            <th>Productores</th>
                            <th>Labores Promedio</th>
                            <th>% Avance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(zonaStats).sort().forEach(zona => {
                const stats = zonaStats[zona];
                const laboresPromedio = (stats.laboresTotal / stats.productores).toFixed(1);
                const porcentajeAvance = ((stats.laboresTotal / (stats.productores * 22)) * 100).toFixed(1);
                
                tableHTML += `
                    <tr>
                        <td><strong>Zona ${zona}</strong></td>
                        <td>${stats.superficie.toFixed(1)}</td>
                        <td>${stats.productores}</td>
                        <td>${laboresPromedio}/22</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="background: #e0e0e0; height: 8px; width: 100px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: rgb(34,116,71); height: 100%; width: ${porcentajeAvance}%; transition: width 0.3s;"></div>
                                </div>
                                <span>${porcentajeAvance}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('zonaAvanceTable').innerHTML = tableHTML;
        }

        // Comparativa por ciclo
        function generateCicloComparativa() {
            const cicloStats = { 'P': { superficie: 0, productores: 0, labores: 0 }, 
                              'S': { superficie: 0, productores: 0, labores: 0 }, 
                              'R': { superficie: 0, productores: 0, labores: 0 } };
            const cicloNames = { 'P': 'Plantilla', 'S': 'Soca', 'R': 'Resoca' };
            
            userData.forEach(record => {
                const ciclo = record.ciclo;
                const superficie = parseFloat(record.superficie || 0);
                
                if (cicloStats[ciclo]) {
                    cicloStats[ciclo].superficie += superficie;
                    cicloStats[ciclo].productores += 1;
                    
                    if (record.labores) {
                        cicloStats[ciclo].labores += Object.values(record.labores).filter(Boolean).length;
                    }
                }
            });
            
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ciclo de Cultivo</th>
                            <th>Superficie (Ha)</th>
                            <th>Productores</th>
                            <th>Labores Promedio</th>
                            <th>% Avance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(cicloStats).forEach(ciclo => {
                const stats = cicloStats[ciclo];
                if (stats.productores > 0) {
                    const laboresPromedio = (stats.labores / stats.productores).toFixed(1);
                    const porcentajeAvance = ((stats.labores / (stats.productores * 22)) * 100).toFixed(1);
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${ciclo} - ${cicloNames[ciclo]}</strong></td>
                            <td>${stats.superficie.toFixed(1)}</td>
                            <td>${stats.productores}</td>
                            <td>${laboresPromedio}/22</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="background: #e0e0e0; height: 8px; width: 100px; border-radius: 4px; overflow: hidden;">
                                        <div style="background: rgb(34,116,71); height: 100%; width: ${porcentajeAvance}%; transition: width 0.3s;"></div>
                                    </div>
                                    <span>${porcentajeAvance}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('cicloComparativa').innerHTML = tableHTML;
        }

        // Cargar tabla de datos
        function loadDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            userData.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.id_prod}</td>
                    <td>${record.nombre_productor}</td>
                    <td>${record.zona}</td>
                    <td>${record.campo}</td>
                    <td>${record.superficie} Ha</td>
                    <td>${record.ciclo}</td>
                    <td>${new Date(record.fecha_avance).toLocaleDateString()}</td>
                    <td>
                        <button onclick="editRecord(${index})" class="action-btn edit-btn">‚úèÔ∏è Editar</button>
                        <button onclick="deleteRecord(${index})" class="action-btn delete-btn">üóëÔ∏è Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Editar registro
        function editRecord(index) {
            const record = userData[index];
            editingIndex = index;
            editingDocId = record.id;
            
            document.getElementById('zafra_ciclo').value = record.zafra_ciclo;
            document.getElementById('zona').value = record.zona;
            document.getElementById('campo').value = record.campo;
            document.getElementById('id_prod').value = record.id_prod;
            document.getElementById('nombre_productor').value = record.nombre_productor;
            document.getElementById('superficie').value = record.superficie;
            document.getElementById('ciclo').value = record.ciclo;
            document.getElementById('regimen').value = record.regimen;
            document.getElementById('fecha_avance').value = record.fecha_avance;
            document.getElementById('observaciones').value = record.observaciones || '';
            
            if (record.labores) {
                Object.entries(record.labores).forEach(([key, value]) => {
                    const checkbox = document.getElementById(key);
                    if (checkbox) checkbox.checked = value;
                });
            }
            
            document.getElementById('cancelEdit').classList.remove('hidden');
            showSection('capture');
            showAlert('Registro cargado para edici√≥n', 'success');
        }

        // Eliminar registro de Firebase
        async function deleteRecord(index) {
            if (confirm('¬øEst√° seguro de que desea eliminar este registro de la base de datos?')) {
                const record = userData[index];
                
                try {
                    await deleteDoc(doc(db, 'labores_agricolas', record.id));
                    showAlert('Registro eliminado exitosamente de Firebase', 'success');
                    await loadDataFromFirebase();
                    loadDataTable();
                } catch (error) {
                    console.error('Error al eliminar:', error);
                    showAlert('Error al eliminar el registro', 'error');
                }
            }
        }

        // Exportar a Excel (completo)
        function exportToExcel() {
            if (userData.length === 0) {
                showAlert('No hay datos para exportar', 'error');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            csvContent += "Zafra-Ciclo,Zona,Campo,ID-Prod,Productor,Superficie,Ciclo,Regimen,Fecha-Avance,Observaciones,Usuario,";
            csvContent += "Desmonte,1er_Barbecho,2do_Barbecho,Ap_Encalado,1ra_Rastra,Surco,Siembra_Amp,Siembra_Rep,Jta_Quema,";
            csvContent += "1er_Cultivo,1er_Cultivo_Yta,1ra_Ap_Fertilizante,1ra_Ap_Fert_Mec,1er_Riego,Subsuelo_Ctral,";
            csvContent += "1ra_Limpia,1ra_Ap_Herbicida,2da_Ap_Ferti,2do_Riego,2da_Limpia,2da_Ap_Herbicida,Resiembra,";
            csvContent += "Total_Labores_Realizadas,Timestamp\n";
            
            userData.forEach(record => {
                const basicData = [
                    record.zafra_ciclo,
                    record.zona,
                    record.campo,
                    record.id_prod,
                    `"${record.nombre_productor}"`,
                    record.superficie,
                    record.ciclo,
                    record.regimen,
                    record.fecha_avance,
                    `"${record.observaciones || ''}"`,
                    record.user
                ];
                
                const labores = record.labores || {};
                const laborData = [
                    labores.desmonte ? 1 : 0,
                    labores.primer_barbecho ? 1 : 0,
                    labores.segundo_barbecho ? 1 : 0,
                    labores.ap_encalado ? 1 : 0,
                    labores.primera_rastra ? 1 : 0,
                    labores.surco ? 1 : 0,
                    labores.siembra_amp ? 1 : 0,
                    labores.siembra_rep ? 1 : 0,
                    labores.jta_quema ? 1 : 0,
                    labores.primer_cultivo ? 1 : 0,
                    labores.primer_cultivo_yta ? 1 : 0,
                    labores.primera_ap_fertilizante ? 1 : 0,
                    labores.primera_ap_fert_mec ? 1 : 0,
                    labores.primer_riego ? 1 : 0,
                    labores.subsuelo_ctral ? 1 : 0,
                    labores.primera_limpia ? 1 : 0,
                    labores.primera_ap_herbicida ? 1 : 0,
                    labores.segunda_ap_ferti ? 1 : 0,
                    labores.segundo_riego ? 1 : 0,
                    labores.segunda_limpia ? 1 : 0,
                    labores.segunda_ap_herbicida ? 1 : 0,
                    labores.resiembra ? 1 : 0
                ];
                
                const totalLabores = laborData.reduce((sum, labor) => sum + labor, 0);
                
                const row = [...basicData, ...laborData, totalLabores, record.timestamp].join(',');
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `base_datos_labores_agricolas_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Base de datos exportada exitosamente (34 columnas)', 'success');
        }

        // B√∫squeda en tiempo real
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#dataTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Eventos de teclado para login
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('password').focus();
            }
        });

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        // Auto-uppercase para nombre del productor
        document.getElementById('nombre_productor').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // Establecer fecha actual por defecto
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha_avance').value = today;
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Captura de Datos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, rgb(34,116,71) 0%, rgba(34,116,71,0.8) 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, rgb(34,116,71), rgba(34,116,71,0.9));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, rgba(34,116,71,0.7), rgba(34,116,71,0.6));
            color: white;
            border: 2px solid rgb(34,116,71);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffffff, #f8f9fa);
            color: rgb(34,116,71);
            border: 2px solid rgb(34,116,71);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: rgb(34,116,71);
            box-shadow: 0 0 0 3px rgba(34,116,71, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: linear-gradient(45deg, rgb(34,116,71), rgba(34,116,71,0.9));
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(45deg, rgb(34,116,71), rgba(34,116,71,0.9));
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .search-box {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .login-form {
            max-width: 450px;
            margin: 80px auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 60px 50px 40px 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .login-header {
            margin-bottom: 40px;
        }

        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .zucarmex-logo {
            display: flex;
            align-items: center;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .logo-triangles {
            margin-right: 6px;
        }

        .triangle {
            display: inline-block;
            width: 0;
            height: 0;
            margin-right: 1px;
        }

        .triangle1, .triangle2, .triangle3 {
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 10px solid rgb(34,116,71);
        }

        .company-title {
            font-size: 32px;
            font-weight: 400;
            color: #333;
            margin: 20px 0 5px 0;
            letter-spacing: 1px;
        }

        .company-subtitle {
            font-size: 18px;
            color: rgb(34,116,71);
            margin-bottom: 40px;
            font-weight: 500;
        }

        .login-title {
            display: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            background: rgba(34,116,71, 0.3);
            padding: 10px 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }

        .edit-btn {
            background: rgb(34,116,71);
        }

        .delete-btn {
            background: #dc3545;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background-color: rgba(34,116,71,0.1);
            color: rgb(34,116,71);
            border: 1px solid rgba(34,116,71,0.3);
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Estilos mejorados para labores agr√≠colas */
        .labores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .labor-item {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(34,116,71, 0.15);
            transition: all 0.2s ease;
        }

        .labor-item:hover {
            background: rgba(34,116,71, 0.05);
            border-color: rgba(34,116,71, 0.25);
            transform: translateY(-1px);
        }

        .labor-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 12px 15px;
            margin: 0;
            font-size: 14px;
            font-weight: 500;
            color: #444;
            gap: 8px;
            width: 100%;
        }

        .labor-checkbox {
            margin: 0 !important;
            width: 18px;
            height: 18px;
            accent-color: rgb(34,116,71);
            cursor: pointer;
            flex-shrink: 0;
        }

        .labor-text {
            user-select: none;
            line-height: 1.2;
        }

        .labor-item:has(.labor-checkbox:checked) {
            background: rgba(34,116,71, 0.1);
            border-color: rgb(34,116,71);
        }

        .labor-item:has(.labor-checkbox:checked) .labor-text {
            color: rgb(34,116,71);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Formulario de Login -->
    <div id="loginSection" class="login-form">
        <div class="login-header">
            <div class="logo-container">
                <div class="zucarmex-logo">
                    <div class="logo-triangles">
                        <div class="triangle triangle1"></div>
                        <div class="triangle triangle2"></div>
                        <div class="triangle triangle3"></div>
                    </div>
                    ZUCARMEX<sup>¬Æ</sup>
                </div>
            </div>
            <div class="company-title">Ingenio Mahuixtl√°n</div>
            <div class="company-subtitle">Avance F√≠sico de Labores Agr√≠colas</div>
        </div>
        
        <h2 class="login-title">Iniciar Sesi√≥n</h2>
        <div class="form-group">
            <label for="username">Usuario</label>
            <input type="text" id="username" placeholder="">
        </div>
        <div class="form-group">
            <label for="password">Contrase√±a</label>
            <input type="password" id="password" placeholder="">
        </div>
        <button onclick="handleLogin()" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px; border-radius: 5px;">Entrar</button>
        <div id="loginAlert" class="alert alert-error hidden">
            Usuario o contrase√±a incorrectos
        </div>
        <div style="margin-top: 20px; padding: 15px; background: rgba(34,116,71,0.1); border-radius: 8px; font-size: 14px; border: 1px solid rgba(34,116,71,0.3);">
            <strong style="color: rgb(34,116,71);">Usuarios de prueba:</strong><br>
            <span style="color: rgb(34,116,71);">admin / admin123<br>
            usuario / pass123<br>
            demo / demo</span>
        </div>
    </div>

    <!-- Aplicaci√≥n Principal -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <h1 style="color: rgb(34,116,71); margin-bottom: 10px;">Ingenio Mahuixtl√°n - Sistema de Captura de Datos</h1>
            <div class="user-info">
                <span>üë§</span>
                <span id="currentUser">Usuario</span>
                <button onclick="logout()" class="btn btn-danger" style="margin-left: auto;">Cerrar Sesi√≥n</button>
            </div>
            <div class="nav-buttons">
                <button onclick="showSection('capture')" class="btn btn-primary">üìù Captura</button>
                <button onclick="showSection('reports')" class="btn btn-secondary">üìä Informes</button>
                <button onclick="showSection('data')" class="btn btn-warning">üìã Datos</button>
                <button onclick="exportToExcel()" class="btn btn-secondary">üì§ Exportar Excel</button>
            </div>
        </div>

        <!-- Secci√≥n de Captura -->
        <div id="captureSection" class="section">
            <h2>Avance F√≠sico de Labores Agr√≠colas</h2>
            
            <!-- Datos del Productor -->
            <div style="background: rgba(34,116,71,0.1); padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 2px solid rgba(34,116,71,0.2);">
                <h3 style="color: rgb(34,116,71); margin-bottom: 15px; font-size: 18px;">üìã DATOS DEL PRODUCTOR</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="zafra_ciclo">Zafra-Ciclo *</label>
                        <select id="zafra_ciclo" required>
                            <option value="">Seleccione zafra-ciclo</option>
                            <option value="2024-2025">2024-2025</option>
                            <option value="2025-2026">2025-2026</option>
                            <option value="2025-2027">2025-2027</option>
                            <option value="2026-2027">2026-2027</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="zona">Zona *</label>
                        <input type="number" id="zona" min="1" max="20" required placeholder="Ej: 4">
                    </div>
                    <div class="form-group">
                        <label for="campo">Campo *</label>
                        <input type="text" id="campo" required placeholder="C√≥digo del campo">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_prod">ID-Prod. *</label>
                        <input type="text" id="id_prod" required placeholder="Ej: 2810032">
                    </div>
                    <div class="form-group">
                        <label for="nombre_productor">Nombre Productor *</label>
                        <input type="text" id="nombre_productor" required placeholder="Nombre completo" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label for="superficie">Superficie (Ha) *</label>
                        <input type="number" id="superficie" step="0.1" min="0" required placeholder="Ej: 3.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="ciclo">Ciclo (P-S-R) *</label>
                        <select id="ciclo" required>
                            <option value="">Seleccione ciclo</option>
                            <option value="P">P - Plantilla</option>
                            <option value="S">S - Soca</option>
                            <option value="R">R - Resoca</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="regimen">R√©gimen (R-T) *</label>
                        <select id="regimen" required>
                            <option value="">Seleccione r√©gimen</option>
                            <option value="R">R - Riego</option>
                            <option value="T">T - Temporal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fecha_avance">Fecha-Avance *</label>
                        <input type="date" id="fecha_avance" required>
                    </div>
                </div>
            </div>

            <!-- Avance de Labores Agr√≠colas -->
            <div style="background: rgba(255,255,255,0.8); padding: 20px; border-radius: 10px; border: 2px solid rgba(34,116,71,0.3);">
                <h3 style="color: rgb(34,116,71); margin-bottom: 15px; font-size: 18px;">üöú AVANCE DE LABORES AGR√çCOLAS REALIZADAS</h3>
                
                <div class="labores-grid">
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="desmonte" class="labor-checkbox">
                            <span class="labor-text">Desmonte</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="primer_barbecho" class="labor-checkbox">
                            <span class="labor-text">1er. Barbecho</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="segundo_barbecho" class="labor-checkbox">
                            <span class="labor-text">2do. Barbecho</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="ap_encalado" class="labor-checkbox">
                            <span class="labor-text">Ap./Encalado</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="primera_rastra" class="labor-checkbox">
                            <span class="labor-text">1ra. Rastra</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="surco" class="labor-checkbox">
                            <span class="labor-text">Surco</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="siembra_amp" class="labor-checkbox">
                            <span class="labor-text">Siembra-Amp.</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="siembra_rep" class="labor-checkbox">
                            <span class="labor-text">Siembra-Rep.</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="jta_quema" class="labor-checkbox">
                            <span class="labor-text">Jta. Quema</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="primer_cultivo" class="labor-checkbox">
                            <span class="labor-text">1er. Cultivo</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="primer_cultivo_yta" class="labor-checkbox">
                            <span class="labor-text">1er. Cultivo/Yta.</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="primera_ap_fertilizante" class="labor-checkbox">
                            <span class="labor-text">1ra. Ap/Fertilizante</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="primera_ap_fert_mec" class="labor-checkbox">
                            <span class="labor-text">1ra. Ap/Fert.Mec.</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="primer_riego" class="labor-checkbox">
                            <span class="labor-text">1er. Riego</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="subsuelo_ctral" class="labor-checkbox">
                            <span class="labor-text">Subsuelo/Ctral.</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="primera_limpia" class="labor-checkbox">
                            <span class="labor-text">1ra. Limpia</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="primera_ap_herbicida" class="labor-checkbox">
                            <span class="labor-text">1ra. Ap/Herbicida</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="segunda_ap_ferti" class="labor-checkbox">
                            <span class="labor-text">2da. Ap/Ferti.</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="segundo_riego" class="labor-checkbox">
                            <span class="labor-text">2do. Riego</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="segunda_limpia" class="labor-checkbox">
                            <span class="labor-text">2da. Limpia</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="segunda_ap_herbicida" class="labor-checkbox">
                            <span class="labor-text">2da. Ap/Herbicida</span>
                        </label>
                    </div>
                    <div class="labor-item">
                        <label class="labor-label">
                            <input type="checkbox" id="resiembra" class="labor-checkbox">
                            <span class="labor-text">Resiembra</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="observaciones">Observaciones</label>
                        <textarea id="observaciones" rows="2" placeholder="Notas adicionales sobre las labores realizadas..."></textarea>
                    </div>
                </div>
            </div>

            <div class="action-buttons" style="margin-top: 25px;">
                <button onclick="saveRecord()" class="btn btn-primary">üíæ Guardar Avance</button>
                <button onclick="clearForm()" class="btn btn-secondary">üóëÔ∏è Limpiar Formulario</button>
                <button id="cancelEdit" onclick="cancelEdit()" class="btn btn-warning hidden">‚ùå Cancelar Edici√≥n</button>
            </div>
            <div id="formAlert"></div>
        </div>

        <!-- Secci√≥n de Informes -->
        <div id="reportsSection" class="section">
            <h2>Informes de Avance por Labor</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSuperficie">0</div>
                    <div>Superficie Total (Ha)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgLaboresPorProductor">0</div>
                    <div>Promedio Labores/Productor</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="productoresActivos">0</div>
                    <div>Productores Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="porcentajeAvanceGeneral">0%</div>
                    <div>% Avance General</div>
                </div>
            </div>
            
            <!-- Reporte de Superficie por Labor -->
            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: rgb(34,116,71); margin-bottom: 15px;">üìä Superficie Trabajada por Labor (Ha)</h3>
                <div id="laborSuperficieTable"></div>
            </div>
            
            <!-- Reporte por Zona/Campo -->
            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: rgb(34,116,71); margin-bottom: 15px;">üó∫Ô∏è Avance por Zona</h3>
                <div id="zonaAvanceTable"></div>
            </div>
            
            <!-- Comparativa por Ciclo -->
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: rgb(34,116,71); margin-bottom: 15px;">üå± Comparativa por Ciclo de Cultivo</h3>
                <div id="cicloComparativa"></div>
            </div>
        </div>

        <!-- Secci√≥n de Datos -->
        <div id="dataSection" class="section">
            <h2>Gesti√≥n de Datos</h2>
            <input type="text" id="searchInput" class="search-box" placeholder="Buscar registros...">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID-Prod</th>
                        <th>Productor</th>
                        <th>Zona</th>
                        <th>Campo</th>
                        <th>Superficie</th>
                        <th>Ciclo</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- Los datos se cargan din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Variables globales
        let userData = [];
        let editingIndex = -1;
        let currentUser = '';

        // Usuarios v√°lidos
        const validUsers = {
            'admin': 'admin123',
            'usuario': 'pass123',
            'demo': 'demo'
        };

        // Funci√≥n de login
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginAlert = document.getElementById('loginAlert');

            if (validUsers[username] && validUsers[username] === password) {
                currentUser = username;
                document.getElementById('currentUser').textContent = username;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showSection('capture');
                loginAlert.classList.add('hidden');
            } else {
                loginAlert.classList.remove('hidden');
            }
        }

        // Funci√≥n de logout
        function logout() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            clearForm();
        }

        // Mostrar secciones
        function showSection(section) {
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.getElementById(section + 'Section').classList.add('active');
            
            if (section === 'reports') {
                updateStats();
            } else if (section === 'data') {
                loadDataTable();
            }
        }

        // Guardar registro
        function saveRecord() {
            const formData = {
                zafra_ciclo: document.getElementById('zafra_ciclo').value,
                zona: document.getElementById('zona').value,
                campo: document.getElementById('campo').value,
                id_prod: document.getElementById('id_prod').value,
                nombre_productor: document.getElementById('nombre_productor').value,
                superficie: document.getElementById('superficie').value,
                ciclo: document.getElementById('ciclo').value,
                regimen: document.getElementById('regimen').value,
                fecha_avance: document.getElementById('fecha_avance').value,
                observaciones: document.getElementById('observaciones').value,
                timestamp: new Date().toISOString(),
                user: currentUser,
                
                // Labores agr√≠colas (checkboxes)
                labores: {
                    desmonte: document.getElementById('desmonte').checked,
                    primer_barbecho: document.getElementById('primer_barbecho').checked,
                    segundo_barbecho: document.getElementById('segundo_barbecho').checked,
                    ap_encalado: document.getElementById('ap_encalado').checked,
                    primera_rastra: document.getElementById('primera_rastra').checked,
                    surco: document.getElementById('surco').checked,
                    siembra_amp: document.getElementById('siembra_amp').checked,
                    siembra_rep: document.getElementById('siembra_rep').checked,
                    jta_quema: document.getElementById('jta_quema').checked,
                    primer_cultivo: document.getElementById('primer_cultivo').checked,
                    primer_cultivo_yta: document.getElementById('primer_cultivo_yta').checked,
                    primera_ap_fertilizante: document.getElementById('primera_ap_fertilizante').checked,
                    primera_ap_fert_mec: document.getElementById('primera_ap_fert_mec').checked,
                    primer_riego: document.getElementById('primer_riego').checked,
                    subsuelo_ctral: document.getElementById('subsuelo_ctral').checked,
                    primera_limpia: document.getElementById('primera_limpia').checked,
                    primera_ap_herbicida: document.getElementById('primera_ap_herbicida').checked,
                    segunda_ap_ferti: document.getElementById('segunda_ap_ferti').checked,
                    segundo_riego: document.getElementById('segundo_riego').checked,
                    segunda_limpia: document.getElementById('segunda_limpia').checked,
                    segunda_ap_herbicida: document.getElementById('segunda_ap_herbicida').checked,
                    resiembra: document.getElementById('resiembra').checked
                }
            };

            // Validar campos requeridos
            const requiredFields = ['zafra_ciclo', 'zona', 'campo', 'id_prod', 'nombre_productor', 'superficie', 'ciclo', 'regimen', 'fecha_avance'];
            let isValid = true;
            
            for (let field of requiredFields) {
                if (!formData[field]) {
                    isValid = false;
                    document.getElementById(field).style.borderColor = '#dc3545';
                } else {
                    document.getElementById(field).style.borderColor = '#e0e0e0';
                }
            }

            if (!isValid) {
                showAlert('Por favor complete todos los campos requeridos (*)', 'error');
                return;
            }

            if (editingIndex >= 0) {
                userData[editingIndex] = formData;
                editingIndex = -1;
                document.getElementById('cancelEdit').classList.add('hidden');
                showAlert('Registro actualizado exitosamente', 'success');
            } else {
                userData.push(formData);
                showAlert('Registro guardado exitosamente', 'success');
            }

            clearForm();
        }

        // Limpiar formulario
        function clearForm() {
            // Campos de texto
            const textFields = ['zafra_ciclo', 'zona', 'campo', 'id_prod', 'nombre_productor', 'superficie', 'ciclo', 'regimen', 'fecha_avance', 'observaciones'];
            textFields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = '';
                    element.style.borderColor = '#e0e0e0';
                }
            });

            // Checkboxes
            const checkboxes = ['desmonte', 'primer_barbecho', 'segundo_barbecho', 'ap_encalado', 'primera_rastra', 'surco', 'siembra_amp', 'siembra_rep', 'jta_quema', 'primer_cultivo', 'primer_cultivo_yta', 'primera_ap_fertilizante', 'primera_ap_fert_mec', 'primer_riego', 'subsuelo_ctral', 'primera_limpia', 'primera_ap_herbicida', 'segunda_ap_ferti', 'segundo_riego', 'segunda_limpia', 'segunda_ap_herbicida', 'resiembra'];
            checkboxes.forEach(checkbox => {
                document.getElementById(checkbox).checked = false;
            });

            editingIndex = -1;
            document.getElementById('cancelEdit').classList.add('hidden');
        }

        // Cancelar edici√≥n
        function cancelEdit() {
            clearForm();
            editingIndex = -1;
            document.getElementById('cancelEdit').classList.add('hidden');
            showAlert('Edici√≥n cancelada', 'success');
        }

        // Mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.getElementById('formAlert');
            alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // Actualizar estad√≠sticas y generar informes
        function updateStats() {
            if (userData.length === 0) {
                document.getElementById('totalSuperficie').textContent = '0';
                document.getElementById('avgLaboresPorProductor').textContent = '0';
                document.getElementById('productoresActivos').textContent = '0';
                document.getElementById('porcentajeAvanceGeneral').textContent = '0%';
                return;
            }

            // Estad√≠sticas generales
            const totalSuperficie = userData.reduce((sum, record) => sum + parseFloat(record.superficie || 0), 0);
            const productoresActivos = userData.length;
            
            // Calcular promedio de labores por productor
            let totalLabores = 0;
            userData.forEach(record => {
                if (record.labores) {
                    totalLabores += Object.values(record.labores).filter(Boolean).length;
                }
            });
            const avgLabores = userData.length > 0 ? (totalLabores / userData.length).toFixed(1) : 0;
            
            // Porcentaje de avance general (sobre 22 labores)
            const porcentajeAvance = userData.length > 0 ? ((totalLabores / (userData.length * 22)) * 100).toFixed(1) : 0;
            
            // Actualizar tarjetas
            document.getElementById('totalSuperficie').textContent = totalSuperficie.toFixed(1);
            document.getElementById('avgLaboresPorProductor').textContent = avgLabores;
            document.getElementById('productoresActivos').textContent = productoresActivos;
            document.getElementById('porcentajeAvanceGeneral').textContent = porcentajeAvance + '%';
            
            // Generar reportes
            generateLaborSuperficieReport();
            generateZonaAvanceReport();
            generateCicloComparativa();
        }

        // Reporte de superficie por labor
        function generateLaborSuperficieReport() {
            const laborNames = {
                'desmonte': 'Desmonte',
                'primer_barbecho': '1er. Barbecho',
                'segundo_barbecho': '2do. Barbecho',
                'ap_encalado': 'Ap./Encalado',
                'primera_rastra': '1ra. Rastra',
                'surco': 'Surco',
                'siembra_amp': 'Siembra-Amp.',
                'siembra_rep': 'Siembra-Rep.',
                'jta_quema': 'Jta. Quema',
                'primer_cultivo': '1er. Cultivo',
                'primer_cultivo_yta': '1er. Cultivo/Yta.',
                'primera_ap_fertilizante': '1ra. Ap/Fertilizante',
                'primera_ap_fert_mec': '1ra. Ap/Fert.Mec.',
                'primer_riego': '1er. Riego',
                'subsuelo_ctral': 'Subsuelo/Ctral.',
                'primera_limpia': '1ra. Limpia',
                'primera_ap_herbicida': '1ra. Ap/Herbicida',
                'segunda_ap_ferti': '2da. Ap/Ferti.',
                'segundo_riego': '2do. Riego',
                'segunda_limpia': '2da. Limpia',
                'segunda_ap_herbicida': '2da. Ap/Herbicida',
                'resiembra': 'Resiembra'
            };

            const laborStats = {};
            
            // Inicializar contadores
            Object.keys(laborNames).forEach(labor => {
                laborStats[labor] = { superficie: 0, productores: 0 };
            });
            
            // Calcular estad√≠sticas
            userData.forEach(record => {
                const superficie = parseFloat(record.superficie || 0);
                if (record.labores) {
                    Object.keys(laborNames).forEach(labor => {
                        if (record.labores[labor]) {
                            laborStats[labor].superficie += superficie;
                            laborStats[labor].productores += 1;
                        }
                    });
                }
            });
            
            // Generar tabla
            let tableHTML = `
                <table class="data-table" style="font-size: 13px;">
                    <thead>
                        <tr>
                            <th>Labor Agr√≠cola</th>
                            <th>Superficie (Ha)</th>
                            <th>Productores</th>
                            <th>% Avance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const totalSuperficie = userData.reduce((sum, record) => sum + parseFloat(record.superficie || 0), 0);
            const totalProductores = userData.length;
            
            Object.keys(laborNames).forEach(labor => {
                const stats = laborStats[labor];
                const porcentaje = totalSuperficie > 0 ? ((stats.superficie / totalSuperficie) * 100).toFixed(1) : 0;
                
                tableHTML += `
                    <tr>
                        <td><strong>${laborNames[labor]}</strong></td>
                        <td>${stats.superficie.toFixed(1)}</td>
                        <td>${stats.productores}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="background: #e0e0e0; height: 8px; width: 100px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: rgb(34,116,71); height: 100%; width: ${porcentaje}%; transition: width 0.3s;"></div>
                                </div>
                                <span>${porcentaje}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('laborSuperficieTable').innerHTML = tableHTML;
        }

        // Reporte por zona
        function generateZonaAvanceReport() {
            const zonaStats = {};
            
            userData.forEach(record => {
                const zona = record.zona || 'Sin zona';
                const superficie = parseFloat(record.superficie || 0);
                
                if (!zonaStats[zona]) {
                    zonaStats[zona] = { superficie: 0, productores: 0, laboresTotal: 0 };
                }
                
                zonaStats[zona].superficie += superficie;
                zonaStats[zona].productores += 1;
                
                if (record.labores) {
                    zonaStats[zona].laboresTotal += Object.values(record.labores).filter(Boolean).length;
                }
            });
            
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Zona</th>
                            <th>Superficie (Ha)</th>
                            <th>Productores</th>
                            <th>Labores Promedio</th>
                            <th>% Avance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(zonaStats).sort().forEach(zona => {
                const stats = zonaStats[zona];
                const laboresPromedio = (stats.laboresTotal / stats.productores).toFixed(1);
                const porcentajeAvance = ((stats.laboresTotal / (stats.productores * 22)) * 100).toFixed(1);
                
                tableHTML += `
                    <tr>
                        <td><strong>Zona ${zona}</strong></td>
                        <td>${stats.superficie.toFixed(1)}</td>
                        <td>${stats.productores}</td>
                        <td>${laboresPromedio}/22</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="background: #e0e0e0; height: 8px; width: 100px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: rgb(34,116,71); height: 100%; width: ${porcentajeAvance}%; transition: width 0.3s;"></div>
                                </div>
                                <span>${porcentajeAvance}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('zonaAvanceTable').innerHTML = tableHTML;
        }

        // Comparativa por ciclo
        function generateCicloComparativa() {
            const cicloStats = { 'P': { superficie: 0, productores: 0, labores: 0 }, 
                              'S': { superficie: 0, productores: 0, labores: 0 }, 
                              'R': { superficie: 0, productores: 0, labores: 0 } };
            const cicloNames = { 'P': 'Plantilla', 'S': 'Soca', 'R': 'Resoca' };
            
            userData.forEach(record => {
                const ciclo = record.ciclo;
                const superficie = parseFloat(record.superficie || 0);
                
                if (cicloStats[ciclo]) {
                    cicloStats[ciclo].superficie += superficie;
                    cicloStats[ciclo].productores += 1;
                    
                    if (record.labores) {
                        cicloStats[ciclo].labores += Object.values(record.labores).filter(Boolean).length;
                    }
                }
            });
            
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ciclo de Cultivo</th>
                            <th>Superficie (Ha)</th>
                            <th>Productores</th>
                            <th>Labores Promedio</th>
                            <th>% Avance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(cicloStats).forEach(ciclo => {
                const stats = cicloStats[ciclo];
                if (stats.productores > 0) {
                    const laboresPromedio = (stats.labores / stats.productores).toFixed(1);
                    const porcentajeAvance = ((stats.labores / (stats.productores * 22)) * 100).toFixed(1);
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${ciclo} - ${cicloNames[ciclo]}</strong></td>
                            <td>${stats.superficie.toFixed(1)}</td>
                            <td>${stats.productores}</td>
                            <td>${laboresPromedio}/22</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="background: #e0e0e0; height: 8px; width: 100px; border-radius: 4px; overflow: hidden;">
                                        <div style="background: rgb(34,116,71); height: 100%; width: ${porcentajeAvance}%; transition: width 0.3s;"></div>
                                    </div>
                                    <span>${porcentajeAvance}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('cicloComparativa').innerHTML = tableHTML;
        }

        // Cargar tabla de datos
        function loadDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            userData.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.id_prod}</td>
                    <td>${record.nombre_productor}</td>
                    <td>${record.zona}</td>
                    <td>${record.campo}</td>
                    <td>${record.superficie} Ha</td>
                    <td>${record.ciclo}</td>
                    <td>${new Date(record.fecha_avance).toLocaleDateString()}</td>
                    <td>
                        <button onclick="editRecord(${index})" class="action-btn edit-btn">‚úèÔ∏è Editar</button>
                        <button onclick="deleteRecord(${index})" class="action-btn delete-btn">üóëÔ∏è Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Editar registro
        function editRecord(index) {
            const record = userData[index];
            editingIndex = index;
            
            // Cargar datos b√°sicos
            document.getElementById('zafra_ciclo').value = record.zafra_ciclo;
            document.getElementById('zona').value = record.zona;
            document.getElementById('campo').value = record.campo;
            document.getElementById('id_prod').value = record.id_prod;
            document.getElementById('nombre_productor').value = record.nombre_productor;
            document.getElementById('superficie').value = record.superficie;
            document.getElementById('ciclo').value = record.ciclo;
            document.getElementById('regimen').value = record.regimen;
            document.getElementById('fecha_avance').value = record.fecha_avance;
            document.getElementById('observaciones').value = record.observaciones || '';
            
            // Cargar checkboxes
            if (record.labores) {
                Object.entries(record.labores).forEach(([key, value]) => {
                    const checkbox = document.getElementById(key);
                    if (checkbox) checkbox.checked = value;
                });
            }
            
            document.getElementById('cancelEdit').classList.remove('hidden');
            showSection('capture');
            showAlert('Registro cargado para edici√≥n', 'success');
        }

        // Eliminar registro
        function deleteRecord(index) {
            if (confirm('¬øEst√° seguro de que desea eliminar este registro?')) {
                userData.splice(index, 1);
                loadDataTable();
                showAlert('Registro eliminado exitosamente', 'success');
            }
        }

        // Exportar a Excel (completo)
        function exportToExcel() {
            if (userData.length === 0) {
                showAlert('No hay datos para exportar', 'error');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Encabezados - Datos b√°sicos + todas las labores
            csvContent += "Zafra-Ciclo,Zona,Campo,ID-Prod,Productor,Superficie,Ciclo,Regimen,Fecha-Avance,Observaciones,Usuario,";
            csvContent += "Desmonte,1er_Barbecho,2do_Barbecho,Ap_Encalado,1ra_Rastra,Surco,Siembra_Amp,Siembra_Rep,Jta_Quema,";
            csvContent += "1er_Cultivo,1er_Cultivo_Yta,1ra_Ap_Fertilizante,1ra_Ap_Fert_Mec,1er_Riego,Subsuelo_Ctral,";
            csvContent += "1ra_Limpia,1ra_Ap_Herbicida,2da_Ap_Ferti,2do_Riego,2da_Limpia,2da_Ap_Herbicida,Resiembra,";
            csvContent += "Total_Labores_Realizadas,Timestamp\n";
            
            userData.forEach(record => {
                // Datos b√°sicos
                const basicData = [
                    record.zafra_ciclo,
                    record.zona,
                    record.campo,
                    record.id_prod,
                    `"${record.nombre_productor}"`,
                    record.superficie,
                    record.ciclo,
                    record.regimen,
                    record.fecha_avance,
                    `"${record.observaciones || ''}"`,
                    record.user
                ];
                
                // Labores agr√≠colas (1/0)
                const labores = record.labores || {};
                const laborData = [
                    labores.desmonte ? 1 : 0,
                    labores.primer_barbecho ? 1 : 0,
                    labores.segundo_barbecho ? 1 : 0,
                    labores.ap_encalado ? 1 : 0,
                    labores.primera_rastra ? 1 : 0,
                    labores.surco ? 1 : 0,
                    labores.siembra_amp ? 1 : 0,
                    labores.siembra_rep ? 1 : 0,
                    labores.jta_quema ? 1 : 0,
                    labores.primer_cultivo ? 1 : 0,
                    labores.primer_cultivo_yta ? 1 : 0,
                    labores.primera_ap_fertilizante ? 1 : 0,
                    labores.primera_ap_fert_mec ? 1 : 0,
                    labores.primer_riego ? 1 : 0,
                    labores.subsuelo_ctral ? 1 : 0,
                    labores.primera_limpia ? 1 : 0,
                    labores.primera_ap_herbicida ? 1 : 0,
                    labores.segunda_ap_ferti ? 1 : 0,
                    labores.segundo_riego ? 1 : 0,
                    labores.segunda_limpia ? 1 : 0,
                    labores.segunda_ap_herbicida ? 1 : 0,
                    labores.resiembra ? 1 : 0
                ];
                
                // Total de labores realizadas
                const totalLabores = laborData.reduce((sum, labor) => sum + labor, 0);
                
                const row = [...basicData, ...laborData, totalLabores, record.timestamp].join(',');
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `base_datos_labores_agricolas_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Base de datos exportada exitosamente (34 columnas)', 'success');
        }

        // B√∫squeda en tiempo real
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#dataTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Eventos de teclado para login
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('password').focus();
            }
        });

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        // Establecer fecha actual por defecto
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha_avance').value = today;
        });

        // Auto-uppercase para nombre del productor
        document.getElementById('nombre_productor').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // Datos de ejemplo para demostraci√≥n
        function loadSampleData() {
            userData = [
                {
                    zafra_ciclo: "2024-2025",
                    zona: "4",
                    campo: "CAM001",
                    id_prod: "2810032",
                    nombre_productor: "JUAN P√âREZ L√ìPEZ",
                    superficie: "3.5",
                    ciclo: "P",
                    regimen: "R",
                    fecha_avance: "2025-01-15",
                    observaciones: "Avance normal, suelo en buenas condiciones",
                    timestamp: new Date().toISOString(),
                    user: "demo",
                    labores: {
                        desmonte: true,
                        primer_barbecho: true,
                        segundo_barbecho: false,
                        ap_encalado: true,
                        primera_rastra: true,
                        surco: false
                    }
                },
                {
                    zafra_ciclo: "2024-2025",
                    zona: "5",
                    campo: "CAM002",
                    id_prod: "2810045",
                    nombre_productor: "MAR√çA GONZ√ÅLEZ HERN√ÅNDEZ",
                    superficie: "2.8",
                    ciclo: "S",
                    regimen: "T",
                    fecha_avance: "2025-01-16",
                    observaciones: "Pendiente aplicaci√≥n de fertilizante",
                    timestamp: new Date().toISOString(),
                    user: "demo",
                    labores: {
                        primer_cultivo: true,
                        primera_ap_fertilizante: false,
                        primer_riego: true,
                        primera_limpia: true
                    }
                }
            ];
        }

        // Cargar datos de ejemplo al iniciar
        loadSampleData();
    </script>
</body>
</html>